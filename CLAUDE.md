# CLAUDE.md

Инструкции для Claude Code при работе с этим репозиторием.

> **Flow, БД схема:** см. `FLOW.md` (локальный, не в git)
> **Прогресс разработки:** см. `PROGRESS.md` (локальный, не в git)
> **Детальные правила по контексту:** см. `.claude/rules/`

---

## Обзор проекта

**Koki Bot** — Telegram бот для 21/42-дневной программы приёма КОК (контрацептивов).

**Основные функции:**
- Менеджер загружает документы (паспорт, чек, карта) → OCR через Gemini Vision → генерация invite-ссылки
- Девушка проходит онбординг (5 шагов через inline-кнопки) → выбирает день цикла и время приёма
- Ежедневно девушка отправляет видео приёма таблетки → AI (Gemini) проверяет → менеджер подтверждает/отклоняет
- Система страйков за опоздание (3 + appeal_count), пересъёмка видео, апелляции
- Воркеры: напоминания, автоснятие, дедлайны

**Tech stack:** Python 3.13+, Aiogram 3.x, Supabase (PostgreSQL), Redis, Gemini 2.5 Flash, Dishka DI

---

## Правила коллаборации

1. **Сначала объясни** — перед написанием кода объясни что и зачем будет сделано
2. **Жди подтверждения** — пиши код только после "пиши код" / "пиши"
3. **Один файл за раз** — не менять несколько файлов без согласования
4. **Только то, что обсудили** — никаких "бонусных" улучшений

---

## Правила написания кода

1. **Импорты вверху** файла, сгруппированы: stdlib → third-party → local
2. **Без неиспользуемых импортов** — удалять сразу
3. **Без неиспользуемых переменных** — если переменная не используется, её не должно быть
4. **Без кода "на будущее"** — не писать пустые методы, заглушки, "пригодится потом". Только то, что используется прямо сейчас
5. **Строгая типизация** — `str | None` (не `Optional[str]`), `list[str]` (не `List[str]`), Pydantic модели для данных из БД (не dict)
6. **Чистый читабельный код** — понятные имена, короткие функции, без магических чисел
7. **Полные импорты** — не использовать `__init__.py` для реэкспорта. Всегда `from repositories.manager_repository import ManagerRepository`, не `from repositories import ManagerRepository`

---

## Обязательная проверка после написания кода

После написания или редактирования ЛЮБОГО файла:

1. **Запустить `mcp__ide__getDiagnostics`** на КАЖДЫЙ изменённый файл — БЕЗ ИСКЛЮЧЕНИЙ
2. **Исправить ВСЕ проблемы:**
   - Unused imports → УДАЛИТЬ
   - Unused variables → УДАЛИТЬ или ИСПОЛЬЗОВАТЬ
   - Type errors → ИСПРАВИТЬ
   - Syntax errors → ИСПРАВИТЬ
   - Linting warnings → ИСПРАВИТЬ
3. **Если таймаут** — fallback:
   ```bash
   python -m py_compile <file.py>
   python -c "from <module> import *"
   ```
4. **Задача НЕ завершена** пока все ошибки не исправлены
5. **INFO "Duplicated code"** — допустимо если это существующий паттерн

---

## Что НЕ делать

- Не писать код, который не будет использован в текущей задаче
- Не добавлять комментарии к очевидному коду
- Не создавать абстракции ради абстракций
- Не использовать `Optional[X]` — только `X | None`
- Не использовать `List`, `Dict`, `Tuple` из typing — только `list`, `dict`, `tuple`
- Не фильтровать данные в Python если можно в запросе к БД
- Не использовать `select("*")` в Supabase

---

## После завершения задачи

Когда логический блок работы завершён (фича, багфикс, рефакторинг):

1. **Напомнить пользователю:** "Задача готова. Запусти `/commit` для коммита и `/progress` для обновления прогресса."
2. **Когда коммитить:** закончил фичу, починил баг, сделал рефакторинг, перед опасным изменением
3. **НЕ коммитить:** незаконченную работу, сломанный код, после каждого мелкого Edit

---

## При сжатии контекста

Когда контекст сжат и нужно продолжить работу — **обязательно прочитать** перед написанием кода:

1. **CLAUDE.md** — правила написания кода (этот файл)
2. **Последние изменённые файлы** — актуальный код, чтобы не сломать

**НЕ писать код** пока не прочитал эти файлы.
